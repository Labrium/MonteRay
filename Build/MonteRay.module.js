/* MonteRay v1.0 alpha Copyright (c) 2021 Tech Labs, Inc. https://techlabsinc.github.io/MonteRay/LICENSE */
 var W=W||{};W.PathtracingRenderer=function(o){this.VERSION="1.0 alpha";var R=1e-5;o=o||{},console.log("Rendering provided by MonteRay v"+this.VERSION+" https://techlabsinc.github.io/MonteRay/LICENSE");var f;o.canvas?f=o.canvas:f=document.createElement("canvas");var C=f.getContext("2d",{alpha:o.alpha===!0}),B,V,_,U,H,Y=new THREE.Color(0);this.domElement=f,this.autoClear=!0,this.setClearColor=function(n){Y.set(n)},this.setPixelRatio=function(n){H=n,this.setSize(B*H,V*H)},this.setSize=function(n,m){B=Math.round(n/H),V=Math.round(m/H),_=B/2,U=V/2,f.style.width=n+"px",f.style.height=m+"px"},this.setSize(f.width,f.height),this.setPixelRatio(1),this.clear=function(){},(!o.BVHAcceleration||o.BVHAcceleration&&o.BVHAcceleration!=!1)&&(THREE.BufferGeometry.prototype.computeBoundsTree=MeshBVHLib.computeBoundsTree,THREE.BufferGeometry.prototype.disposeBoundsTree=MeshBVHLib.disposeBoundsTree,THREE.Mesh.prototype.raycast=MeshBVHLib.acceleratedRaycast);function oe(n,m){return Math.floor(Math.random()*(m-n+1))+n}var F=1;this.download=function(){var n=document.createElement("a");n.setAttribute("href",f.toDataURL()),n.setAttribute("download",document.title+"_"+F+".png"),F++,n.style.display="none",document.body.appendChild(n),n.onclick=function(m){m.stopPropagation()},n.click(),document.body.removeChild(n),o.nextFrame()};var g=1;this.render=function(n,m){var j=B,E=V,ne=_,le=U;f.width=j,f.height=E;var w=1,ce=Math.PI*2,I=new THREE.Color(0),t=new THREE.Raycaster;t.firstHitOnly=!0;for(var P=[],G=new THREE.Vector2(1/j,1/E),z=0;z<E;z++)for(var D=0;D<j;D++)P.push(new THREE.Vector2(D/j*2-1,-(z/E)*2+1));n.updateMatrixWorld(),m.updateMatrixWorld();try{document.getElementById("sa").innerHTML="Analyzing scene..."}catch(e){}var O=[];n.traverseVisible(function(e){try{(!o.BVHAcceleration||o.BVHAcceleration&&o.BVHAcceleration!=!1)&&e instanceof THREE.Mesh&&e.geometry.computeBoundsTree(),I.equals(e.material.emissive)||O.push([e,new MeshSurfaceSampler(e).build()])}catch(i){}});var k=O.length;try{document.getElementById("sa").innerHTML="Pre-rendering..."}catch(e){}for(var S=[],u=[],Z=P.length,T=0;T<Z;T++){var v=new THREE.Color(0),N=P[T];t.setFromCamera(N,m);var y=t.intersectObjects(n.children,!0)[0],$=1;if(y==null)v.add(n.background);else try{if(I.equals(y.object.material.emissive))y.object.material.isMeshBasicMaterial?v.copy(y.object.material.colors):(v.setScalar(y.distance/m.far),S.push([N,y,2,new THREE.Color(0),T*4]));else{var Q=1;y.object.material.emissiveIntensity&&(Q=y.object.material.emissiveIntensity),v.copy(y.object.material.color),v.multiply(y.object.material.emissive.clone().multiplyScalar(Q))}}catch(e){v.setScalar(y.distance/m.far),S.push([N,y,2,new THREE.Color(0),T*4])}u.push(v.r*255),u.push(v.g*255),u.push(v.b*255),u.push($*255)}var x=new ImageData(new Uint8ClampedArray(u),j,E);C.putImageData(x,0,0),S.sort(function(e,i){return e[1].distance-i[1].distance});function ee(e){return e.face.normal.clone().applyMatrix3(new THREE.Matrix3().getNormalMatrix(e.object.matrixWorld)).normalize()}var h=!1;function s(e,i){var r;if(r=t.intersectObjects(n.children,!0)[0],r==null)return n.background;if(i>4&&(i>20||Math.random()>Math.max(r.object.material.color.r,Math.max(r.object.material.color.g,r.object.material.color.b))))return I;var l=ee(r),c=I.clone();if(I.equals(r.object.material.emissive)){if(r.object.material.mirror||r.object.material.metalness==1)return t.ray.origin.copy(r.point),t.ray.direction.reflect(l),s([e[0],r,e[2],e[3],e[4]],i+1);if(r.object.material.glass)return h==!1?(t.ray.origin.copy(r.point.addScaledVector(l,-R)),t.ray.direction.lerp(l.clone().negate(),r.object.material.refractionRatio),h=!0,s([e[0],r,e[2],e[3],e[4]],i+1)):(t.ray.origin.copy(r.point.addScaledVector(l,R)),t.ray.direction.lerp(l,r.object.material.refractionRatio),h=!1,s([e[0],r,e[2],e[3],e[4]],i));var A=0,K=1;for(o.lightSamples&&(K=Math.floor(Math.random()*o.lightSamples));A<K;){var L=new THREE.Vector3,X=O[Math.floor(Math.random()*k)];if(X[1].sample(L),L.copy(X[0].localToWorld(L)),t.set(r.point.addScaledVector(l,1e-12),new THREE.Vector3().normalize()),t.ray.lookAt(L),o.advancedLighting)if(Math.random()>.5){var a=s([e[0],r,e[2],e[3],e[4]],i+1),b=l.dot(t.ray.direction);c.add(r.object.material.color.clone().multiply(a.clone().multiplyScalar(b)))}else{var a=t.intersectObjects(n.children,!0)[0],b=l.dot(t.ray.direction);if(o.recursiveLighting){if(a!=null){var d=1;a.object.material.emissiveIntensity&&(d=a.object.material.emissiveIntensity),c.add(a.object.material.color.clone().multiply(a.object.material.emissive.clone().multiplyScalar(d)))}else a.object.material.mirror||a.object.material.metalness==1?(t.ray.origin.copy(a.point),t.ray.direction.reflect(l),c.add(s([e[0],a,e[2],e[3],e[4]],i+1))):a.object.material.glass?h==!1?(t.ray.origin.copy(a.point.addScaledVector(l,-R)),t.ray.direction.lerp(l.clone().negate(),a.object.material.refractionRatio),h=!0,c.add(s([e[0],a,e[2],e[3],e[4]],i+1))):(t.ray.origin.copy(a.point.addScaledVector(l,R)),t.ray.direction.lerp(l,a.object.material.refractionRatio),h=!1,c.add(s([e[0],a,e[2],e[3],e[4]],i))):c.add(n.background);c.multiply(r.object.material.color)}else if(a!=null){var b=l.dot(t.ray.direction),d=1;a.object.material.emissiveIntensity&&(d=a.object.material.emissiveIntensity),c.add(r.object.material.color.clone().multiply(a.object.material.color.clone().multiply(a.object.material.emissive.clone().multiplyScalar(b).multiplyScalar(k).multiplyScalar(d))))}}else{var a=t.intersectObjects(n.children,!0)[0],b=l.dot(t.ray.direction);if(o.recursiveLighting){if(a!=null){var d=1;a.object.material.emissiveIntensity&&(d=a.object.material.emissiveIntensity),c.add(a.object.material.color.clone().multiply(a.object.material.emissive.clone().multiplyScalar(d)))}else a.object.material.mirror||a.object.material.metalness==1?(t.ray.origin.copy(a.point),t.ray.direction.reflect(l),c.add(s([e[0],a,e[2],e[3],e[4]],i+1))):a.object.material.glass?h==!1?(t.ray.origin.copy(a.point.addScaledVector(l,-R)),t.ray.direction.lerp(l.clone().negate(),a.object.material.refractionRatio),h=!0,c.add(s([e[0],a,e[2],e[3],e[4]],i+1))):(t.ray.origin.copy(a.point.addScaledVector(l,R)),t.ray.direction.lerp(l,a.object.material.refractionRatio),h=!1,c.add(s([e[0],a,e[2],e[3],e[4]],i))):c.add(n.background);c.multiply(r.object.material.color).multiplyScalar(l.dot(t.ray.direction))}else if(a!=null){var b=l.dot(t.ray.direction),d=1;a.object.material.emissiveIntensity&&(d=a.object.material.emissiveIntensity),c.add(r.object.material.color.clone().multiply(a.object.material.color.clone().multiply(a.object.material.emissive.clone().multiplyScalar(b).multiplyScalar(k).multiplyScalar(d))))}}A++}o.lightSamples&&c.multiplyScalar(1/(A+1)),q.lookAt(l);var re=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()*.5).applyQuaternion(q.quaternion);t.set(r.point,re);var de=1/(2*Math.PI),b=l.dot(t.ray.direction),me=1/Math.PI,te=s([e[0],r,e[2],e[3],e[4]],i+1);return c.multiplyScalar(1).add(r.object.material.color.clone().multiply(te).multiplyScalar(b*2))}else{var d=1;return r.object.material.emissiveIntensity&&(d=r.object.material.emissiveIntensity),r.object.material.color.clone().multiply(r.object.material.emissive.clone().multiplyScalar(d))}}var q=new THREE.Object3D,M=0;o.fps||(g=S.length,o.pixelBatchSize&&(g=o.pixelBatchSize));var p=0,ae=this;function J(){try{for(var e=0;e<g;e++){var i=S[M],r=S[M][2]-1;if(r<1&&(r=1),t.setFromCamera(new THREE.Vector2(i[0].x+(Math.random()-.5)*G.x,i[0].y+(Math.random()-.5)*G.y),m),i[3].multiplyScalar(r-1),i[3].add(s(i,0)),i[3].multiplyScalar(1/r),S[M][2]++,M++,u[i[4]]=i[3].r*255,u[i[4]+1]=i[3].g*255,u[i[4]+2]=i[3].b*255,u[i[4]+3]=255,M>=S.length){if(M=0,(o.maxSamples||o.downloadInterval)&&(w>=o.maxSamples||w%o.downloadInterval==0)){var l=new ImageData(new Uint8ClampedArray(u),j,E);if(C.putImageData(l,0,0),ae.download(),w>=o.maxSamples){try{document.getElementById("sa").innerHTML="Render Complete"}catch(A){}return}}w++}}var l=new ImageData(new Uint8ClampedArray(u),j,E);if(C.putImageData(l,0,0),o.fps){var c=performance.now();c-p>1e3/o.fps?g-=10:c-p<1e3/o.fps&&(g+=100),g<1&&(g=1);try{document.getElementById("sa").innerHTML=j+"x"+E+"<br />"+w+"spp "+g+"ppf "+Math.round(1/((c-p)/1e3))+"fps"}catch(d){}p=performance.now()}}catch(d){console.log(d)}setTimeout(J,0)}setTimeout(J,0)}};var ie=W.PathtracingRenderer;export{ie as PathtracingRenderer};
