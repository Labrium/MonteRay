/* MonteRay Alpha 2 Copyright (c) 2021 Tech Labs, Inc. https://techlabsinc.github.io/MonteRay/LICENSE */
 var u=u||{};u.DepthRenderMode=0,u.RandomRenderMode=1,u.LinearRenderMode=2,u.CenterRenderMode=3,u.Color=function(t,r,m,y){return r===void 0&&m===void 0?this.set(t):y===void 0?this.setRGB(t,r,m):this.setRGBA(t,r,m,y)},Object.assign(u.Color.prototype,{isMonteRayColor:!0,r:1,g:1,b:1,a:1,maxVal:function(){return Math.max(this.r,Math.max(this.g,this.b))},maxValA:function(){return Math.max(this.r,Math.max(this.g,Math.max(this.b,this.a)))},set:function(t){return t&&t.isMonteRayColor?this.copy(t):t&&t.isColor?this.fromTHREEColor(t,1):typeof t=="number"?this.setHex(t):typeof t=="string"&&this.fromTHREEColor(new THREE.Color().setStyle(t)),this},setRGB:function(t,r,m){return this.r=t,this.g=r,this.b=m,this},setRGBA:function(t,r,m,y){return this.r=t,this.g=r,this.b=m,this.a=y,this},setHex:function(t){return t=Math.floor(t),t.toString(16).length>6?(this.r=(t>>24&255)/255,this.g=(t>>16&255)/255,this.b=(t>>8&255)/255,this.a=(t&255)/255):(this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(t&255)/255),this},setScalar:function(t){return this.r=t,this.g=t,this.b=t,this},setScalarA:function(t){return this.r=t,this.g=t,this.b=t,this.a=t,this},setR:function(t){return this.r=t,this},setG:function(t){return this.g=t,this},setB:function(t){return this.b=t,this},setA:function(t){return this.a=t,this},setComponent:function(t,r){switch(t){case 0:this.r=r;break;case 1:this.g=r;break;case 2:this.b=r;break;case 3:this.a=r;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.r;case 1:return this.g;case 2:return this.b;case 3:return this.a;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.r,this.g,this.b,this.a)},copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},add:function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this},addA:function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},addScalar:function(t){return this.r+=t,this.g+=t,this.b+=t,this},addScalarA:function(t){return this.r+=t,this.g+=t,this.b+=t,this.a+=t,this},addColors:function(t,r){return this.r=t.r+r.r,this.g=t.g+r.g,this.b=t.b+r.b,this},addColorsA:function(t,r){return this.r=t.r+r.r,this.g=t.g+r.g,this.b=t.b+r.b,this.a=t.a+r.a,this},sub:function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this},subA:function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},subScalar:function(t){return this.r-=t,this.g-=t,this.b-=t,this},subScalarA:function(t){return this.r-=t,this.g-=t,this.b-=t,this.a-=t,this},subColors:function(t,r){return this.r=t.r-r.r,this.g=t.g-r.g,this.b=t.b-r.b,this},subColorsA:function(t,r){return this.r=t.r-r.r,this.g=t.g-r.g,this.b=t.b-r.b,this.a=t.a-r.a,this},multiply:function(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this},multiplyA:function(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this.a*=t.a,this},multiplyScalar:function(t){return this.r*=t,this.g*=t,this.b*=t,this},multiplyScalarA:function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},divideScalar:function(t){return this.multiplyScalar(1/t)},divideScalarA:function(t){return this.multiplyScalarA(1/t)},min:function(t){return this.r=Math.min(this.r,t.r),this.g=Math.min(this.g,t.g),this.b=Math.min(this.b,t.b),this},minA:function(t){return this.r=Math.min(this.r,t.r),this.g=Math.min(this.g,t.g),this.b=Math.min(this.b,t.b),this.a=Math.min(this.a,t.a),this},max:function(t){return this.r=Math.max(this.r,t.r),this.g=Math.max(this.g,t.g),this.b=Math.max(this.b,t.b),this},maxA:function(t){return this.r=Math.max(this.r,t.r),this.g=Math.max(this.g,t.g),this.b=Math.max(this.b,t.b),this.a=Math.max(this.a,t.a),this},clamp:function(t,r){return this.r=Math.max(t.r,Math.min(r.r,this.r)),this.g=Math.max(t.g,Math.min(r.g,this.g)),this.b=Math.max(t.b,Math.min(r.b,this.b)),this},clampA:function(t,r){return this.r=Math.max(t.r,Math.min(r.r,this.r)),this.g=Math.max(t.g,Math.min(r.g,this.g)),this.b=Math.max(t.b,Math.min(r.b,this.b)),this.a=Math.max(t.a,Math.min(r.a,this.a)),this},clampScalar:function(t,r){return this.r=Math.max(t,Math.min(r,this.r)),this.g=Math.max(t,Math.min(r,this.g)),this.b=Math.max(t,Math.min(r,this.b)),this},clampScalarA:function(t,r){return this.r=Math.max(t,Math.min(r,this.r)),this.g=Math.max(t,Math.min(r,this.g)),this.b=Math.max(t,Math.min(r,this.b)),this.a=Math.max(t,Math.min(r,this.a)),this},clampV:function(){this.clampScalarA(0,1)},invert:function(){return this.r=-this.r,this.g=-this.g,this.b=-this.b,this},invertA:function(){return this.r=-this.r,this.g=-this.g,this.b=-this.b,this.a=-this.a,this},lerp:function(t,r){return this.r+=(t.r-this.r)*r,this.g+=(t.g-this.g)*r,this.b+=(t.b-this.b)*r,this},lerpA:function(t,r){return this.r+=(t.r-this.r)*r,this.g+=(t.g-this.g)*r,this.b+=(t.b-this.b)*r,this.a+=(t.a-this.a)*r,this},lerpColors:function(t,r,m){return this.r=t.r+(r.r-t.r)*m,this.g=t.g+(r.g-t.g)*m,this.b=t.b+(r.b-t.b)*m,this},lerpColorsA:function(t,r,m){return this.r=t.r+(r.r-t.r)*m,this.g=t.g+(r.g-t.g)*m,this.b=t.b+(r.b-t.b)*m,this.a=t.a+(r.a-t.a)*m,this},equals:function(t){return t.r===this.r&&t.g===this.g&&t.b===this.b},equalsA:function(t){return t.r===this.r&&t.g===this.g&&t.b===this.b&&t.a===this.a},fromArray:function(t,r){return r==null&&(r=0),this.r=t[r],this.g=t[r+1],this.b=t[r+2],this.a=t[r+3],this},toArray:function(t,r){return t==null&&(t=[]),r==null&&(r=0),t[r]=this.r,t[r+1]=this.g,t[r+2]=this.b,t[r+3]=this.a,t},fromBufferAttribute:function(t,r){return this.r=t.getX(r),this.g=t.getY(r),this.b=t.getZ(r),this.a=t.getW(r),this},fromTHREEColor:function(t,r){return r==null&&(r=1),this.setRGB(t.r,t.g,t.b,r),this},random:function(){return this.r=Math.random(),this.g=Math.random(),this.b=Math.random(),this},randomA:function(){return this.r=Math.random(),this.g=Math.random(),this.b=Math.random(),this.a=Math.random(),this}}),u.Color.imageDataToHex=function(t,r,m,y){return t<<24^r<<16^m<<8^y<<0},u.PathtracingRenderer=function(t){this.VERSION="Alpha 2";var r=Math.pow(.1,-52);t=t||{};var m=this;console.log("Rendering provided by MonteRay "+this.VERSION+" https://techlabsinc.github.io/MonteRay/LICENSE");var y;t.canvas?y=t.canvas:y=document.createElement("canvas");var K=y.getContext("2d",{alpha:t.alpha===!0}),j,G,ht,st,L,$=new u.Color(0);this.domElement=y,this.autoClear=!0,this.setClearColor=function(d,b){$.setScalar(d),$.setA(b)},this.getClearColor=function(){return $.toColor()},this.setPixelRatio=function(d){L=d,this.setSize(j*L,G*L)},this.setSize=function(d,b){j=Math.round(d/L),G=Math.round(b/L),ht=j/2,st=G/2,y.style.width=d+"px",y.style.height=b+"px"},this.setSize(y.width,y.height),this.setPixelRatio(1),this.clear=function(){},(!t.BVHAcceleration||t.BVHAcceleration&&t.BVHAcceleration!=!1)&&(THREE.BufferGeometry.prototype.computeBoundsTree=MeshBVHLib.computeBoundsTree,THREE.BufferGeometry.prototype.disposeBoundsTree=MeshBVHLib.disposeBoundsTree,THREE.Mesh.prototype.raycast=MeshBVHLib.acceleratedRaycast);var lt=1;this.download=function(){var d=document.createElement("a");d.setAttribute("href",y.toDataURL()),d.setAttribute("download",document.title+"_"+lt+".png"),lt++,d.style.display="none",document.body.appendChild(d),d.onclick=function(b){b.stopPropagation()},d.click(),document.body.removeChild(d)};var I=1,k=1,U=!0,p=1,v=j,M=G,O=[];this.clearTextureCache=function(){O=[]},this.currentSamples=function(){return p},this.getSize=function(){return new THREE.Vector2(v,M)},this.getPixelRatio=function(){return L};var g=[],V=0;this.resetSamples=function(){for(var d=0;d<g.length;d++)g[d][2]=2;V=0,p=1},this.render=function(d,b){var B=!1;v=j,M=G;var pt=ht,At=st;y.width=v,y.height=M,p=1;var bt=Math.PI*2,q=new u.Color(0),s=new THREE.Raycaster;s.firstHitOnly=!0;function vt(i){var e=new THREE.Vector3,o=new THREE.Vector3;return o.copy(i.point).applyMatrix4(new THREE.Matrix4().copy(i.object.matrixWorld).invert()),Mt(e,o,i.object.material.flatShading,i.face,i.object.geometry),e.applyMatrix3(new THREE.Matrix3().getNormalMatrix(i.object.matrixWorld)).normalize(),e}var Mt=function(){var i=new THREE.Vector3,e=new THREE.Vector3,o=new THREE.Vector3,n=new THREE.Vector3,h=new THREE.Vector3,a=new THREE.Vector3;return function f(T,C,A,R,c){try{var l=R.normal;if(A===!0)T.copy(l);else{try{var z=c.attributes.position,N=c.attributes.normal}catch(St){var z=c._bufferGeometry.attributes.position,N=c._bufferGeometry.attributes.normal}i.fromBufferAttribute(z,R.a),e.fromBufferAttribute(z,R.b),o.fromBufferAttribute(z,R.c),a.crossVectors(n.subVectors(e,i),h.subVectors(o,i));var w=l.dot(a);a.crossVectors(n.subVectors(e,C),h.subVectors(o,C));var gt=l.dot(a),J=gt/w;a.crossVectors(n.subVectors(o,C),h.subVectors(i,C));var wt=l.dot(a),yt=wt/w,Ht=1-J-yt;n.fromBufferAttribute(N,R.a),h.fromBufferAttribute(N,R.b),a.fromBufferAttribute(N,R.c),n.multiplyScalar(J),h.multiplyScalar(yt),a.multiplyScalar(Ht),T.addVectors(n,h),T.add(a)}}catch(St){f(T,C,A,R,new THREE.BufferGeometry().fromGeometry(c))}}}();function ut(){for(var i=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()*.5);i.normalize().dot(new THREE.Vector3(0,0,1))<Math.random();)i=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()*.5);return i}function x(i,e){if(!O[i.id]){var o=document.createElement("canvas").getContext("2d");o.canvas.width=i.image.width,o.canvas.height=i.image.height,o.drawImage(i.image,0,0);for(var n=[].slice.call(o.getImageData(0,0,o.canvas.width,o.canvas.height).data),h=[],a=0;a<n.length;a+=4)h.push(u.Color.imageDataToHex(n[a],n[a+1],n[a+2],n[a+3]));O[i.id]=[];for(var a=0;a<h.length;a+=o.canvas.width)O[i.id].push(h.slice(a,a+o.canvas.width))}var f=new THREE.Vector2,T=new THREE.Vector2(1,1);f.x=Math.floor(e.x*T.x*i.image.width),f.y=Math.floor((1-e.y*T.y)*i.image.height);try{var C=O[i.id][f.y][f.x]}catch(A){console.log(e)}return C?new u.Color(C):new u.Color}function F(){if(d.background.isColor)return new u.Color().fromTHREEColor(d.background);var i={};return i.radius=Math.sqrt(s.ray.direction.x*s.ray.direction.x+s.ray.direction.y*s.ray.direction.y+-s.ray.direction.z*-s.ray.direction.z),i.radius===0?(i.theta=0,i.phi=0):(i.theta=Math.atan2(s.ray.direction.x,-s.ray.direction.z),i.phi=Math.acos(THREE.MathUtils.clamp(s.ray.direction.y/i.radius,-1,1))),x(d.background,new THREE.Vector2((i.theta+Math.PI)/bt,1-i.phi/Math.PI))}function Q(i){var e={};if(i){if(!q.equals(new u.Color().fromTHREEColor(i.object.material.emissive))||i.object.material.isMeshBasicMaterial?e.type="GLOW":i.object.material.mirror||i.object.material.metalness==1?e.type="SPEC":i.object.material.glass?e.type="REFR":e.type="DIFF",e.color=new u.Color().fromTHREEColor(i.object.material.color),i.object.material.map&&e.color.multiply(x(i.object.material.map,i.uv)),e.emissive=new u.Color().fromTHREEColor(i.object.material.emissive),i.object.material.emissiveIntensity?e.emissiveIntensity=i.object.material.emissiveIntensity:e.emissiveIntensity=0,i.object.material.refractionRatio?e.refractionRatio=i.object.material.refractionRatio:e.refractionRatio=0,e.point=i.point,e.normal=vt(i).normalize(),i.object.material.normalMap){var o=x(i.object.material.normalMap,i.uv);e.normal.x+=(o.r-.5)*2,e.normal.y+=(o.g-.5)*2,e.normal.normalize()}return e}else return{type:"DIFF",color:F(),point:new THREE.Vector3,normal:new THREE.Vector3}}function tt(i,e){s.ray.origin.copy(i.point),s.ray.direction.reflect(e)}function it(i,e){B==!1?(s.ray.origin.copy(i.point.addScaledVector(e,-r)),s.ray.direction.lerp(e.clone().negate(),i.refractionRatio),B=!0):(s.ray.origin.copy(i.point.addScaledVector(e,r)),s.ray.direction.lerp(e,i.refractionRatio),B=!1)}for(var rt=[],dt=new THREE.Vector2(1/v,1/M),et=0;et<M;et++)for(var nt=0;nt<v;nt++)rt.push(new THREE.Vector2((nt+.5)/v*2-1,-((et+.5)/M)*2+1));d.updateMatrixWorld(),b.updateMatrixWorld();try{document.getElementById("sa").innerHTML="Analyzing scene..."}catch(i){}var at=[];d.traverseVisible(function(i){try{(!t.BVHAcceleration||t.BVHAcceleration&&t.BVHAcceleration!=!1)&&i instanceof THREE.Mesh&&i.geometry.computeBoundsTree(),q.equals(new u.Color().fromTHREEColor(i.material.emissive))||at.push([i,new MeshSurfaceSampler(i).build()])}catch(e){}});var ot=at.length;try{document.getElementById("sa").innerHTML="Pre-rendering..."}catch(i){}for(var H=[],Et=rt.length,P=0;P<Et;P++){var S=new u.Color(0),W=rt[P];s.setFromCamera(W,b);var D=s.intersectObjects(d.children,!0)[0];if(D==null)S.add(F()),t.antialiasBackground&&g.push([W,{distance:Infinity},2,new u.Color(0,0,0,1),P*4]);else try{var _=Q(D);if(_.type=="GLOW"){var ct=1;_.emissiveIntensity&&(ct=_.emissiveIntensity),S.copy(_.color),S.add(_.emissive.multiplyScalar(ct)),t.antialiasBackground&&g.push([W,D,2,new u.Color(0,0,0,1),P*4])}else S.setScalar(D.distance/b.far),g.push([W,D,2,new u.Color(0,0,0,1),P*4]),t.alpha&&S.setA(0)}catch(i){console.log(i),S.setScalar(D.distance/b.far),g.push([W,D,2,new u.Color(0,0,0,1),P*4]),t.alpha&&S.setA(0)}H.push(S.r*255),H.push(S.g*255),H.push(S.b*255),H.push(S.a*255)}if(K.putImageData(new ImageData(new Uint8ClampedArray(H),v,M),0,0),!t.renderMode||t.renderMode&&t.renderMode==u.DepthRenderMode)g.sort(function(i,e){return i[1].distance-e[1].distance});else if(t.renderMode&&t.renderMode==u.CenterRenderMode)g.sort(function(i,e){var o=new THREE.Vector3(0,0),n=new THREE.Vector2(i[0].x*b.aspect,i[0].y),h=new THREE.Vector2(e[0].x*b.aspect,e[0].y);return n.distanceTo(o)-h.distanceTo(o)});else if(t.renderMode&&t.renderMode==u.RandomRenderMode)for(var X=0;X<g.length;X++){var ft=Math.random()*g.length|0,Rt=g[ft];g[ft]=g[X],g[X]=Rt}function E(i,e){B=!1;var o;if(o=s.intersectObjects(d.children,!0)[0],o==null)return F();var n=Q(o);if(e>4&&(e>20||Math.random()>n.color.maxVal()))return q;var h=n.normal;if(n.type=="NORM")return new u.Color(h.x*.5+.5,h.y*.5+.5,h.z*.5+.5);var a=q.clone();if(n.type=="GLOW"){var f=1;return n.emissiveIntensity&&(f=n.emissiveIntensity),n.color.clone().add(n.emissive.clone().multiplyScalar(f))}else{if(n.type=="SPEC")return tt(n,h),E([i[0],o,i[2],i[3],i[4]],e+1).multiply(n.color);if(n.type=="REFR")return it(n,h),B==!1?E([i[0],o,i[2],i[3],i[4]],e+1):E([i[0],o,i[2],i[3],i[4]],e);var T=0,C=1;for(t.lightSamples&&(C=Math.floor(Math.random()*t.lightSamples));T<C;){var A=new THREE.Vector3,R=at[Math.floor(Math.random()*ot)];if(R!=null?(R[1].sample(A,new THREE.Vector3),A.copy(R[0].localToWorld(A))):(Y.lookAt(h),A.copy(ut().applyQuaternion(Y.quaternion))),s.set(n.point.addScaledVector(h,1e-12),new THREE.Vector3().normalize()),s.ray.lookAt(A),t.advancedLighting)if(Math.random()>.5){var c=E([i[0],o,i[2],i[3],i[4]],e+1),w=h.dot(s.ray.direction);a.add(n.color.clone().multiply(c.clone().multiplyScalar(w)))}else{var c=s.intersectObjects(d.children,!0)[0],l=Q(c),w=h.dot(s.ray.direction);if(t.recursiveLighting){if(c!=null){var f=1;l.type=="GLOW"&&(f=c.object.material.emissiveIntensity),a.add(l.color.clone().add(l.emissive.clone().multiplyScalar(f)))}else l.type=="SPEC"?(tt(l,h),a.add(E([i[0],c,i[2],i[3],i[4]],e+1).multiply(n.color))):l.type=="REFR"?(it(l,h),B==!1?a.add(E([i[0],c,i[2],i[3],i[4]],e+1)):a.add(E([i[0],c,i[2],i[3],i[4]],e))):a.add(F());a.multiply(l.color)}else if(c!=null){var w=h.dot(s.ray.direction),f=1;l.emissiveIntensity&&(f=l.emissiveIntensity),a.add(n.color.clone().multiply(l.color.clone().multiply(l.emissive.clone().multiplyScalar(w).multiplyScalar(ot).multiplyScalar(f))))}}else{var c=s.intersectObjects(d.children,!0)[0],l=Q(c),w=h.dot(s.ray.direction);if(t.recursiveLighting){if(c!=null){var f=1;l.emissiveIntensity&&(f=l.emissiveIntensity),a.add(l.color.clone().multiply(l.emissive.clone().multiplyScalar(f)))}else l.type=="SPEC"?(tt(l,h),a.add(E([i[0],c,i[2],i[3],i[4]],e+1).multiply(n.color))):l.type=="REFR"?(it(l,h),B==!1?a.add(E([i[0],c,i[2],i[3],i[4]],e+1)):a.add(E([i[0],c,i[2],i[3],i[4]],e))):a.add(F());a.multiply(n.color).multiplyScalar(h.dot(s.ray.direction))}else if(c!=null){var w=h.dot(s.ray.direction),f=1;l.emissiveIntensity&&(f=l.emissiveIntensity),a.add(n.color.clone().multiply(l.color.clone().multiply(l.emissive.clone().multiplyScalar(w).multiplyScalar(ot).multiplyScalar(f))))}}T++}t.lightSamples&&a.divideScalar(T+1),Y.lookAt(h);var z=ut().applyQuaternion(Y.quaternion);s.set(o.point,z);var N=1/(2*Math.PI),w=h.dot(s.ray.direction),gt=1/Math.PI,J=E([i[0],o,i[2],i[3],i[4]],e+1);return a.multiplyScalar(1).add(n.color.clone().multiply(J).multiplyScalar(w))}}var Y=new THREE.Object3D;V=0,t.fps||(I=g.length,t.pixelBatchSize&&(I=t.pixelBatchSize));var Z=0;try{document.getElementById("sa").innerHTML=v+"x"+M+"<br />Rendering 1 sample per pixel..."}catch(i){}function mt(){try{for(var i=0;i<I;i++){var e=g[V],o=g[V][2]-1;if(o<1&&(o=1),s.setFromCamera(new THREE.Vector2(e[0].x+(Math.random()-.5)*dt.x*2,e[0].y+(Math.random()-.5)*dt.y*2),b),e[3].multiplyScalar(o-1),e[3].add(E(e,0)),e[3].divideScalar(o),e[3].clampV(),g[V][2]++,V++,H[e[4]]=e[3].r*255,H[e[4]+1]=e[3].g*255,H[e[4]+2]=e[3].b*255,H[e[4]+3]=e[3].a*255,V>=g.length){if(V=0,(t.maxSamples||t.downloadInterval)&&(p>=t.maxSamples||p%t.downloadInterval==0)&&(K.putImageData(new ImageData(new Uint8ClampedArray(H),v,M),0,0),m.download(),p>=t.maxSamples)){try{document.getElementById("sa").innerHTML="Render Complete"}catch(h){}return t.nextFrame()}p++;try{document.getElementById("sa").innerHTML=v+"x"+M+"<br />Rendering "+p+" samples per pixel..."}catch(h){}}}if(K.putImageData(new ImageData(new Uint8ClampedArray(H),v,M),0,0),t.fps){var n=Date.now();n-Z>1e3/t.fps?(U==!0&&(k=0,U=!1),k-=1):n-Z<1e3/t.fps&&(U==!1&&(k=0,U=!0),k+=1),I+=k,I<1&&(I=1);try{document.getElementById("sa").innerHTML=v+"x"+M+"<br />"+p+"spp "+I+"ppf "+Math.round(1/((n-Z)/1e3))+"fps"}catch(h){}Z=Date.now()}}catch(h){console.log(h)}requestAnimationFrame(mt)}requestAnimationFrame(mt)}};var Tt=u.PathtracingRenderer,Ct=u.Color;export{Ct as Color,Tt as PathtracingRenderer};
