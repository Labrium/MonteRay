/* MonteRay Alpha 2 Copyright (c) 2021 Tech Labs, Inc. https://techlabsinc.github.io/MonteRay/LICENSE */
var MonteRay=MonteRay||{};MonteRay.DepthRenderMode=0,MonteRay.RandomRenderMode=1,MonteRay.LinearRenderMode=2,MonteRay.CenterRenderMode=3,MonteRay.Color=function(t,r,f,g){return r===void 0&&f===void 0?this.set(t):g===void 0?this.setRGB(t,r,f):this.setRGBA(t,r,f,g)},Object.assign(MonteRay.Color.prototype,{isMonteRayColor:!0,r:1,g:1,b:1,a:1,maxVal:function(){return Math.max(this.r,Math.max(this.g,this.b))},maxValA:function(){return Math.max(this.r,Math.max(this.g,Math.max(this.b,this.a)))},set:function(t){return t&&t.isMonteRayColor?this.copy(t):t&&t.isColor?this.fromTHREEColor(t,1):typeof t=="number"?this.setHex(t):typeof t=="string"&&this.fromTHREEColor(new THREE.Color().setStyle(t)),this},setRGB:function(t,r,f){return this.r=t,this.g=r,this.b=f,this},setRGBA:function(t,r,f,g){return this.r=t,this.g=r,this.b=f,this.a=g,this},setHex:function(t){return t=Math.floor(t),t.toString(16).length>6?(this.r=(t>>24&255)/255,this.g=(t>>16&255)/255,this.b=(t>>8&255)/255,this.a=(t&255)/255):(this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(t&255)/255),this},setScalar:function(t){return this.r=t,this.g=t,this.b=t,this},setScalarA:function(t){return this.r=t,this.g=t,this.b=t,this.a=t,this},setR:function(t){return this.r=t,this},setG:function(t){return this.g=t,this},setB:function(t){return this.b=t,this},setA:function(t){return this.a=t,this},setComponent:function(t,r){switch(t){case 0:this.r=r;break;case 1:this.g=r;break;case 2:this.b=r;break;case 3:this.a=r;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.r;case 1:return this.g;case 2:return this.b;case 3:return this.a;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.r,this.g,this.b,this.a)},copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},add:function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this},addA:function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},addScalar:function(t){return this.r+=t,this.g+=t,this.b+=t,this},addScalarA:function(t){return this.r+=t,this.g+=t,this.b+=t,this.a+=t,this},addColors:function(t,r){return this.r=t.r+r.r,this.g=t.g+r.g,this.b=t.b+r.b,this},addColorsA:function(t,r){return this.r=t.r+r.r,this.g=t.g+r.g,this.b=t.b+r.b,this.a=t.a+r.a,this},sub:function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this},subA:function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},subScalar:function(t){return this.r-=t,this.g-=t,this.b-=t,this},subScalarA:function(t){return this.r-=t,this.g-=t,this.b-=t,this.a-=t,this},subColors:function(t,r){return this.r=t.r-r.r,this.g=t.g-r.g,this.b=t.b-r.b,this},subColorsA:function(t,r){return this.r=t.r-r.r,this.g=t.g-r.g,this.b=t.b-r.b,this.a=t.a-r.a,this},multiply:function(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this},multiplyA:function(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this.a*=t.a,this},multiplyScalar:function(t){return this.r*=t,this.g*=t,this.b*=t,this},multiplyScalarA:function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},divideScalar:function(t){return this.multiplyScalar(1/t)},divideScalarA:function(t){return this.multiplyScalarA(1/t)},min:function(t){return this.r=Math.min(this.r,t.r),this.g=Math.min(this.g,t.g),this.b=Math.min(this.b,t.b),this},minA:function(t){return this.r=Math.min(this.r,t.r),this.g=Math.min(this.g,t.g),this.b=Math.min(this.b,t.b),this.a=Math.min(this.a,t.a),this},max:function(t){return this.r=Math.max(this.r,t.r),this.g=Math.max(this.g,t.g),this.b=Math.max(this.b,t.b),this},maxA:function(t){return this.r=Math.max(this.r,t.r),this.g=Math.max(this.g,t.g),this.b=Math.max(this.b,t.b),this.a=Math.max(this.a,t.a),this},clamp:function(t,r){return this.r=Math.max(t.r,Math.min(r.r,this.r)),this.g=Math.max(t.g,Math.min(r.g,this.g)),this.b=Math.max(t.b,Math.min(r.b,this.b)),this},clampA:function(t,r){return this.r=Math.max(t.r,Math.min(r.r,this.r)),this.g=Math.max(t.g,Math.min(r.g,this.g)),this.b=Math.max(t.b,Math.min(r.b,this.b)),this.a=Math.max(t.a,Math.min(r.a,this.a)),this},clampScalar:function(t,r){return this.r=Math.max(t,Math.min(r,this.r)),this.g=Math.max(t,Math.min(r,this.g)),this.b=Math.max(t,Math.min(r,this.b)),this},clampScalarA:function(t,r){return this.r=Math.max(t,Math.min(r,this.r)),this.g=Math.max(t,Math.min(r,this.g)),this.b=Math.max(t,Math.min(r,this.b)),this.a=Math.max(t,Math.min(r,this.a)),this},clampV:function(){this.clampScalarA(0,1)},invert:function(){return this.r=-this.r,this.g=-this.g,this.b=-this.b,this},invertA:function(){return this.r=-this.r,this.g=-this.g,this.b=-this.b,this.a=-this.a,this},lerp:function(t,r){return this.r+=(t.r-this.r)*r,this.g+=(t.g-this.g)*r,this.b+=(t.b-this.b)*r,this},lerpA:function(t,r){return this.r+=(t.r-this.r)*r,this.g+=(t.g-this.g)*r,this.b+=(t.b-this.b)*r,this.a+=(t.a-this.a)*r,this},lerpColors:function(t,r,f){return this.r=t.r+(r.r-t.r)*f,this.g=t.g+(r.g-t.g)*f,this.b=t.b+(r.b-t.b)*f,this},lerpColorsA:function(t,r,f){return this.r=t.r+(r.r-t.r)*f,this.g=t.g+(r.g-t.g)*f,this.b=t.b+(r.b-t.b)*f,this.a=t.a+(r.a-t.a)*f,this},equals:function(t){return t.r===this.r&&t.g===this.g&&t.b===this.b},equalsA:function(t){return t.r===this.r&&t.g===this.g&&t.b===this.b&&t.a===this.a},fromArray:function(t,r){return r==null&&(r=0),this.r=t[r],this.g=t[r+1],this.b=t[r+2],this.a=t[r+3],this},toArray:function(t,r){return t==null&&(t=[]),r==null&&(r=0),t[r]=this.r,t[r+1]=this.g,t[r+2]=this.b,t[r+3]=this.a,t},fromBufferAttribute:function(t,r){return this.r=t.getX(r),this.g=t.getY(r),this.b=t.getZ(r),this.a=t.getW(r),this},fromTHREEColor:function(t,r){return r==null&&(r=1),this.setRGB(t.r,t.g,t.b,r),this},random:function(){return this.r=Math.random(),this.g=Math.random(),this.b=Math.random(),this},randomA:function(){return this.r=Math.random(),this.g=Math.random(),this.b=Math.random(),this.a=Math.random(),this}}),MonteRay.Color.imageDataToHex=function(t,r,f,g){return t<<24^r<<16^f<<8^g<<0},MonteRay.PathtracingRenderer=function(t){this.VERSION="Alpha 2";var r=Math.pow(.1,-52);t=t||{};var f=this;console.log("Rendering provided by MonteRay "+this.VERSION+" https://techlabsinc.github.io/MonteRay/LICENSE");var g;t.canvas?g=t.canvas:g=document.createElement("canvas");var J=g.getContext("2d",{alpha:t.alpha===!0}),z,j,at,ht,L,K=new MonteRay.Color(0);this.domElement=g,this.autoClear=!0,this.setClearColor=function(u,y){K.setScalar(u),K.setA(y)},this.getClearColor=function(){return K.toColor()},this.setPixelRatio=function(u){L=u,this.setSize(z*L,j*L)},this.setSize=function(u,y){z=Math.round(u/L),j=Math.round(y/L),at=z/2,ht=j/2,g.style.width=u+"px",g.style.height=y+"px"},this.setSize(g.width,g.height),this.setPixelRatio(1),this.clear=function(){},(!t.BVHAcceleration||t.BVHAcceleration&&t.BVHAcceleration!=!1)&&(THREE.BufferGeometry.prototype.computeBoundsTree=MeshBVHLib.computeBoundsTree,THREE.BufferGeometry.prototype.disposeBoundsTree=MeshBVHLib.disposeBoundsTree,THREE.Mesh.prototype.raycast=MeshBVHLib.acceleratedRaycast);var st=1;this.download=function(){var u=document.createElement("a");u.setAttribute("href",g.toDataURL()),u.setAttribute("download",document.title+"_"+st+".png"),st++,u.style.display="none",document.body.appendChild(u),u.onclick=function(y){y.stopPropagation()},u.click(),document.body.removeChild(u)};var V=1,G=1,N=!0,C=1,b=z,v=j,k=[];this.clearTextureCache=function(){k=[]},this.currentSamples=function(){return C},this.getSize=function(){return new THREE.Vector2(b,v)},this.getPixelRatio=function(){return L};var m=[],A=0;this.resetSamples=function(){for(var u=0;u<m.length;u++)m[u][2]=2;A=0,C=1},this.render=function(u,y){var I=!1;b=z,v=j;var St=at,Tt=ht;g.width=b,g.height=v,C=1;var yt=Math.PI*2,U=new MonteRay.Color(0),s=new THREE.Raycaster;s.firstHitOnly=!0;function bt(i){var e=new THREE.Vector3,a=new THREE.Vector3;return a.copy(i.point).applyMatrix4(new THREE.Matrix4().copy(i.object.matrixWorld).invert()),vt(e,a,i.object.material.flatShading,i.face,i.object.geometry),e.applyMatrix3(new THREE.Matrix3().getNormalMatrix(i.object.matrixWorld)).normalize(),e}var vt=function(){var i=new THREE.Vector3,e=new THREE.Vector3,a=new THREE.Vector3,n=new THREE.Vector3,h=new THREE.Vector3,o=new THREE.Vector3;return function c(S,T,p,E,d){try{var l=E.normal;if(p===!0)S.copy(l);else{try{var P=d.attributes.position,_=d.attributes.normal}catch(Ht){var P=d._bufferGeometry.attributes.position,_=d._bufferGeometry.attributes.normal}i.fromBufferAttribute(P,E.a),e.fromBufferAttribute(P,E.b),a.fromBufferAttribute(P,E.c),o.crossVectors(n.subVectors(e,i),h.subVectors(a,i));var R=l.dot(o);o.crossVectors(n.subVectors(e,T),h.subVectors(a,T));var mt=l.dot(o),Z=mt/R;o.crossVectors(n.subVectors(a,T),h.subVectors(i,T));var Rt=l.dot(o),gt=Rt/R,wt=1-Z-gt;n.fromBufferAttribute(_,E.a),h.fromBufferAttribute(_,E.b),o.fromBufferAttribute(_,E.c),n.multiplyScalar(Z),h.multiplyScalar(gt),o.multiplyScalar(wt),S.addVectors(n,h),S.add(o)}}catch(Ht){c(S,T,p,E,new THREE.BufferGeometry().fromGeometry(d))}}}();function lt(){for(var i=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()*.5);i.normalize().dot(new THREE.Vector3(0,0,1))<Math.random();)i=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()*.5);return i}function $(i,e){if(!k[i.id]){var a=document.createElement("canvas").getContext("2d");a.canvas.width=i.image.width,a.canvas.height=i.image.height,a.drawImage(i.image,0,0);for(var n=[].slice.call(a.getImageData(0,0,a.canvas.width,a.canvas.height).data),h=[],o=0;o<n.length;o+=4)h.push(MonteRay.Color.imageDataToHex(n[o],n[o+1],n[o+2],n[o+3]));k[i.id]=[];for(var o=0;o<h.length;o+=a.canvas.width)k[i.id].push(h.slice(o,o+a.canvas.width))}var c=new THREE.Vector2,S=new THREE.Vector2(1,1);c.x=Math.floor(e.x*S.x*i.image.width),c.y=Math.floor((1-e.y*S.y)*i.image.height);try{var T=k[i.id][c.y][c.x]}catch(p){console.log(e)}return T?new MonteRay.Color(T):new MonteRay.Color}function O(){if(u.background.isColor)return new MonteRay.Color().fromTHREEColor(u.background);var i={};return i.radius=Math.sqrt(s.ray.direction.x*s.ray.direction.x+s.ray.direction.y*s.ray.direction.y+-s.ray.direction.z*-s.ray.direction.z),i.radius===0?(i.theta=0,i.phi=0):(i.theta=Math.atan2(s.ray.direction.x,-s.ray.direction.z),i.phi=Math.acos(THREE.MathUtils.clamp(s.ray.direction.y/i.radius,-1,1))),$(u.background,new THREE.Vector2((i.theta+Math.PI)/yt,1-i.phi/Math.PI))}function q(i){var e={};if(i){if(!U.equals(new MonteRay.Color().fromTHREEColor(i.object.material.emissive))||i.object.material.isMeshBasicMaterial?e.type="GLOW":i.object.material.mirror||i.object.material.metalness==1?e.type="SPEC":i.object.material.glass?e.type="REFR":e.type="DIFF",e.color=new MonteRay.Color().fromTHREEColor(i.object.material.color),i.object.material.map&&e.color.multiply($(i.object.material.map,i.uv)),e.emissive=new MonteRay.Color().fromTHREEColor(i.object.material.emissive),i.object.material.emissiveIntensity?e.emissiveIntensity=i.object.material.emissiveIntensity:e.emissiveIntensity=0,i.object.material.refractionRatio?e.refractionRatio=i.object.material.refractionRatio:e.refractionRatio=0,e.point=i.point,e.normal=bt(i).normalize(),i.object.material.normalMap){var a=$(i.object.material.normalMap,i.uv);e.normal.x+=(a.r-.5)*2,e.normal.y+=(a.g-.5)*2,e.normal.normalize()}return e}else return{type:"DIFF",color:O(),point:new THREE.Vector3,normal:new THREE.Vector3}}function x(i,e){s.ray.origin.copy(i.point),s.ray.direction.reflect(e)}function tt(i,e){I==!1?(s.ray.origin.copy(i.point.addScaledVector(e,-r)),s.ray.direction.lerp(e.clone().negate(),i.refractionRatio),I=!0):(s.ray.origin.copy(i.point.addScaledVector(e,r)),s.ray.direction.lerp(e,i.refractionRatio),I=!1)}for(var it=[],ut=new THREE.Vector2(1/b,1/v),rt=0;rt<v;rt++)for(var et=0;et<b;et++)it.push(new THREE.Vector2((et+.5)/b*2-1,-((rt+.5)/v)*2+1));u.updateMatrixWorld(),y.updateMatrixWorld();try{document.getElementById("sa").innerHTML="Analyzing scene..."}catch(i){}var nt=[];u.traverseVisible(function(i){try{(!t.BVHAcceleration||t.BVHAcceleration&&t.BVHAcceleration!=!1)&&i instanceof THREE.Mesh&&i.geometry.computeBoundsTree(),U.equals(new MonteRay.Color().fromTHREEColor(i.material.emissive))||nt.push([i,new MeshSurfaceSampler(i).build()])}catch(e){}});var ot=nt.length;try{document.getElementById("sa").innerHTML="Pre-rendering..."}catch(i){}for(var w=[],Mt=it.length,B=0;B<Mt;B++){var H=new MonteRay.Color(0),F=it[B];s.setFromCamera(F,y);var D=s.intersectObjects(u.children,!0)[0];if(D==null)H.add(O()),t.antialiasBackground&&m.push([F,{distance:Infinity},2,new MonteRay.Color(0,0,0,1),B*4]);else try{var W=q(D);if(W.type=="GLOW"){var dt=1;W.emissiveIntensity&&(dt=W.emissiveIntensity),H.copy(W.color),H.add(W.emissive.multiplyScalar(dt)),t.antialiasBackground&&m.push([F,D,2,new MonteRay.Color(0,0,0,1),B*4])}else H.setScalar(D.distance/y.far),m.push([F,D,2,new MonteRay.Color(0,0,0,1),B*4]),t.alpha&&H.setA(0)}catch(i){console.log(i),H.setScalar(D.distance/y.far),m.push([F,D,2,new MonteRay.Color(0,0,0,1),B*4]),t.alpha&&H.setA(0)}w.push(H.r*255),w.push(H.g*255),w.push(H.b*255),w.push(H.a*255)}if(J.putImageData(new ImageData(new Uint8ClampedArray(w),b,v),0,0),!t.renderMode||t.renderMode&&t.renderMode==MonteRay.DepthRenderMode)m.sort(function(i,e){return i[1].distance-e[1].distance});else if(t.renderMode&&t.renderMode==MonteRay.CenterRenderMode)m.sort(function(i,e){var a=new THREE.Vector3(0,0),n=new THREE.Vector2(i[0].x*y.aspect,i[0].y),h=new THREE.Vector2(e[0].x*y.aspect,e[0].y);return n.distanceTo(a)-h.distanceTo(a)});else if(t.renderMode&&t.renderMode==MonteRay.RandomRenderMode)for(var Q=0;Q<m.length;Q++){var ct=Math.random()*m.length|0,Et=m[ct];m[ct]=m[Q],m[Q]=Et}function M(i,e){I=!1;var a;if(a=s.intersectObjects(u.children,!0)[0],a==null)return O();var n=q(a);if(e>4&&(e>20||Math.random()>n.color.maxVal()))return U;var h=n.normal;if(n.type=="NORM")return new MonteRay.Color(h.x*.5+.5,h.y*.5+.5,h.z*.5+.5);var o=U.clone();if(n.type=="GLOW"){var c=1;return n.emissiveIntensity&&(c=n.emissiveIntensity),n.color.clone().add(n.emissive.clone().multiplyScalar(c))}else{if(n.type=="SPEC")return x(n,h),M([i[0],a,i[2],i[3],i[4]],e+1).multiply(n.color);if(n.type=="REFR")return tt(n,h),I==!1?M([i[0],a,i[2],i[3],i[4]],e+1):M([i[0],a,i[2],i[3],i[4]],e);var S=0,T=1;for(t.lightSamples&&(T=Math.floor(Math.random()*t.lightSamples));S<T;){var p=new THREE.Vector3,E=nt[Math.floor(Math.random()*ot)];if(E!=null?(E[1].sample(p,new THREE.Vector3),p.copy(E[0].localToWorld(p))):(X.lookAt(h),p.copy(lt().applyQuaternion(X.quaternion))),s.set(n.point.addScaledVector(h,1e-12),new THREE.Vector3().normalize()),s.ray.lookAt(p),t.advancedLighting)if(Math.random()>.5){var d=M([i[0],a,i[2],i[3],i[4]],e+1),R=h.dot(s.ray.direction);o.add(n.color.clone().multiply(d.clone().multiplyScalar(R)))}else{var d=s.intersectObjects(u.children,!0)[0],l=q(d),R=h.dot(s.ray.direction);if(t.recursiveLighting){if(d!=null){var c=1;l.type=="GLOW"&&(c=d.object.material.emissiveIntensity),o.add(l.color.clone().add(l.emissive.clone().multiplyScalar(c)))}else l.type=="SPEC"?(x(l,h),o.add(M([i[0],d,i[2],i[3],i[4]],e+1).multiply(n.color))):l.type=="REFR"?(tt(l,h),I==!1?o.add(M([i[0],d,i[2],i[3],i[4]],e+1)):o.add(M([i[0],d,i[2],i[3],i[4]],e))):o.add(O());o.multiply(l.color)}else if(d!=null){var R=h.dot(s.ray.direction),c=1;l.emissiveIntensity&&(c=l.emissiveIntensity),o.add(n.color.clone().multiply(l.color.clone().multiply(l.emissive.clone().multiplyScalar(R).multiplyScalar(ot).multiplyScalar(c))))}}else{var d=s.intersectObjects(u.children,!0)[0],l=q(d),R=h.dot(s.ray.direction);if(t.recursiveLighting){if(d!=null){var c=1;l.emissiveIntensity&&(c=l.emissiveIntensity),o.add(l.color.clone().multiply(l.emissive.clone().multiplyScalar(c)))}else l.type=="SPEC"?(x(l,h),o.add(M([i[0],d,i[2],i[3],i[4]],e+1).multiply(n.color))):l.type=="REFR"?(tt(l,h),I==!1?o.add(M([i[0],d,i[2],i[3],i[4]],e+1)):o.add(M([i[0],d,i[2],i[3],i[4]],e))):o.add(O());o.multiply(n.color).multiplyScalar(h.dot(s.ray.direction))}else if(d!=null){var R=h.dot(s.ray.direction),c=1;l.emissiveIntensity&&(c=l.emissiveIntensity),o.add(n.color.clone().multiply(l.color.clone().multiply(l.emissive.clone().multiplyScalar(R).multiplyScalar(ot).multiplyScalar(c))))}}S++}t.lightSamples&&o.divideScalar(S+1),X.lookAt(h);var P=lt().applyQuaternion(X.quaternion);s.set(a.point,P);var _=1/(2*Math.PI),R=h.dot(s.ray.direction),mt=1/Math.PI,Z=M([i[0],a,i[2],i[3],i[4]],e+1);return o.multiplyScalar(1).add(n.color.clone().multiply(Z).multiplyScalar(R))}}var X=new THREE.Object3D;A=0,t.fps||(V=m.length,t.pixelBatchSize&&(V=t.pixelBatchSize));var Y=0;try{document.getElementById("sa").innerHTML=b+"x"+v+"<br />Rendering 1 sample per pixel..."}catch(i){}function ft(){try{for(var i=0;i<V;i++){var e=m[A],a=m[A][2]-1;if(a<1&&(a=1),s.setFromCamera(new THREE.Vector2(e[0].x+(Math.random()-.5)*ut.x*2,e[0].y+(Math.random()-.5)*ut.y*2),y),e[3].multiplyScalar(a-1),e[3].add(M(e,0)),e[3].divideScalar(a),e[3].clampV(),m[A][2]++,A++,w[e[4]]=e[3].r*255,w[e[4]+1]=e[3].g*255,w[e[4]+2]=e[3].b*255,w[e[4]+3]=e[3].a*255,A>=m.length){if(A=0,(t.maxSamples||t.downloadInterval)&&(C>=t.maxSamples||C%t.downloadInterval==0)&&(J.putImageData(new ImageData(new Uint8ClampedArray(w),b,v),0,0),f.download(),C>=t.maxSamples)){try{document.getElementById("sa").innerHTML="Render Complete"}catch(h){}return t.nextFrame()}C++;try{document.getElementById("sa").innerHTML=b+"x"+v+"<br />Rendering "+C+" samples per pixel..."}catch(h){}}}if(J.putImageData(new ImageData(new Uint8ClampedArray(w),b,v),0,0),t.fps){var n=Date.now();n-Y>1e3/t.fps?(N==!0&&(G=0,N=!1),G-=1):n-Y<1e3/t.fps&&(N==!1&&(G=0,N=!0),G+=1),V+=G,V<1&&(V=1);try{document.getElementById("sa").innerHTML=b+"x"+v+"<br />"+C+"spp "+V+"ppf "+Math.round(1/((n-Y)/1e3))+"fps"}catch(h){}Y=Date.now()}}catch(h){console.log(h)}requestAnimationFrame(ft)}requestAnimationFrame(ft)}};
