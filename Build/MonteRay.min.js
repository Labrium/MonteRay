/* MonteRay v1.0 alpha Copyright (c) 2021 Tech Labs, Inc. https://techlabsinc.github.io/MonteRay/LICENSE */
var MonteRay=MonteRay||{};MonteRay.PathtracingRenderer=function(i){this.VERSION="1.0 alpha";var M=1e-5;i=i||{},console.log("Rendering provided by MonteRay v"+this.VERSION+" https://techlabsinc.github.io/MonteRay/LICENSE");var u;i.canvas?u=i.canvas:u=document.createElement("canvas");var C=u.getContext("2d",{alpha:i.alpha===!0}),B,V,_,U,H,Y=new THREE.Color(0);this.domElement=u,this.autoClear=!0,this.setClearColor=function(n){Y.set(n)},this.setPixelRatio=function(n){H=n,this.setSize(B*H,V*H)},this.setSize=function(n,m){B=Math.round(n/H),V=Math.round(m/H),_=B/2,U=V/2,u.style.width=n+"px",u.style.height=m+"px"},this.setSize(u.width,u.height),this.setPixelRatio(1),this.clear=function(){},(!i.BVHAcceleration||i.BVHAcceleration&&i.BVHAcceleration!=!1)&&(THREE.BufferGeometry.prototype.computeBoundsTree=MeshBVHLib.computeBoundsTree,THREE.BufferGeometry.prototype.disposeBoundsTree=MeshBVHLib.disposeBoundsTree,THREE.Mesh.prototype.raycast=MeshBVHLib.acceleratedRaycast);function te(n,m){return Math.floor(Math.random()*(m-n+1))+n}var F=1;this.download=function(){var n=document.createElement("a");n.setAttribute("href",u.toDataURL()),n.setAttribute("download",document.title+"_"+F+".png"),F++,n.style.display="none",document.body.appendChild(n),n.onclick=function(m){m.stopPropagation()},n.click(),document.body.removeChild(n),i.nextFrame()};var g=1;this.render=function(n,m){var j=B,E=V,ie=_,oe=U;u.width=j,u.height=E;var w=1,ne=Math.PI*2,I=new THREE.Color(0),t=new THREE.Raycaster;t.firstHitOnly=!0;for(var z=[],G=new THREE.Vector2(1/j,1/E),D=0;D<E;D++)for(var O=0;O<j;O++)z.push(new THREE.Vector2((O+.5)/j*2-1,-((D+.5)/E)*2+1));n.updateMatrixWorld(),m.updateMatrixWorld();try{document.getElementById("sa").innerHTML="Analyzing scene..."}catch(e){}var k=[];n.traverseVisible(function(e){try{(!i.BVHAcceleration||i.BVHAcceleration&&i.BVHAcceleration!=!1)&&e instanceof THREE.Mesh&&e.geometry.computeBoundsTree(),I.equals(e.material.emissive)||k.push([e,new MeshSurfaceSampler(e).build()])}catch(o){}});var P=k.length;try{document.getElementById("sa").innerHTML="Pre-rendering..."}catch(e){}for(var S=[],s=[],Z=z.length,T=0;T<Z;T++){var v=new THREE.Color(0),N=z[T];t.setFromCamera(N,m);var y=t.intersectObjects(n.children,!0)[0],W=1;if(y==null)v.add(n.background);else try{if(I.equals(y.object.material.emissive))y.object.material.isMeshBasicMaterial?v.copy(y.object.material.colors):(v.setScalar(y.distance/m.far),S.push([N,y,2,new THREE.Color(0),T*4]),i.alpha&&(W=0));else{var Q=1;y.object.material.emissiveIntensity&&(Q=y.object.material.emissiveIntensity),v.copy(y.object.material.color),v.multiply(y.object.material.emissive.clone().multiplyScalar(Q))}}catch(e){v.setScalar(y.distance/m.far),S.push([N,y,2,new THREE.Color(0),T*4]),i.alpha&&(W=0)}s.push(v.r*255),s.push(v.g*255),s.push(v.b*255),s.push(W*255)}var $=new ImageData(new Uint8ClampedArray(s),j,E);C.putImageData($,0,0),S.sort(function(e,o){return e[1].distance-o[1].distance});function x(e){return e.face.normal.clone().applyMatrix3(new THREE.Matrix3().getNormalMatrix(e.object.matrixWorld)).normalize()}var h=!1;function f(e,o){var r;if(r=t.intersectObjects(n.children,!0)[0],r==null)return n.background;if(o>4&&(o>20||Math.random()>Math.max(r.object.material.color.r,Math.max(r.object.material.color.g,r.object.material.color.b))))return I;var l=x(r),c=I.clone();if(I.equals(r.object.material.emissive)){if(r.object.material.mirror||r.object.material.metalness==1)return t.ray.origin.copy(r.point),t.ray.direction.reflect(l),f([e[0],r,e[2],e[3],e[4]],o+1);if(r.object.material.glass)return h==!1?(t.ray.origin.copy(r.point.addScaledVector(l,-M)),t.ray.direction.lerp(l.clone().negate(),r.object.material.refractionRatio),h=!0,f([e[0],r,e[2],e[3],e[4]],o+1)):(t.ray.origin.copy(r.point.addScaledVector(l,M)),t.ray.direction.lerp(l,r.object.material.refractionRatio),h=!1,f([e[0],r,e[2],e[3],e[4]],o));var A=0,K=1;for(i.lightSamples&&(K=Math.floor(Math.random()*i.lightSamples));A<K;){var L=new THREE.Vector3,X=k[Math.floor(Math.random()*P)];if(X[1].sample(L),L.copy(X[0].localToWorld(L)),t.set(r.point.addScaledVector(l,1e-12),new THREE.Vector3().normalize()),t.ray.lookAt(L),i.advancedLighting)if(Math.random()>.5){var a=f([e[0],r,e[2],e[3],e[4]],o+1),b=l.dot(t.ray.direction);c.add(r.object.material.color.clone().multiply(a.clone().multiplyScalar(b)))}else{var a=t.intersectObjects(n.children,!0)[0],b=l.dot(t.ray.direction);if(i.recursiveLighting){if(a!=null){var d=1;a.object.material.emissiveIntensity&&(d=a.object.material.emissiveIntensity),c.add(a.object.material.color.clone().multiply(a.object.material.emissive.clone().multiplyScalar(d)))}else a.object.material.mirror||a.object.material.metalness==1?(t.ray.origin.copy(a.point),t.ray.direction.reflect(l),c.add(f([e[0],a,e[2],e[3],e[4]],o+1))):a.object.material.glass?h==!1?(t.ray.origin.copy(a.point.addScaledVector(l,-M)),t.ray.direction.lerp(l.clone().negate(),a.object.material.refractionRatio),h=!0,c.add(f([e[0],a,e[2],e[3],e[4]],o+1))):(t.ray.origin.copy(a.point.addScaledVector(l,M)),t.ray.direction.lerp(l,a.object.material.refractionRatio),h=!1,c.add(f([e[0],a,e[2],e[3],e[4]],o))):c.add(n.background);c.multiply(r.object.material.color)}else if(a!=null){var b=l.dot(t.ray.direction),d=1;a.object.material.emissiveIntensity&&(d=a.object.material.emissiveIntensity),c.add(r.object.material.color.clone().multiply(a.object.material.color.clone().multiply(a.object.material.emissive.clone().multiplyScalar(b).multiplyScalar(P).multiplyScalar(d))))}}else{var a=t.intersectObjects(n.children,!0)[0],b=l.dot(t.ray.direction);if(i.recursiveLighting){if(a!=null){var d=1;a.object.material.emissiveIntensity&&(d=a.object.material.emissiveIntensity),c.add(a.object.material.color.clone().multiply(a.object.material.emissive.clone().multiplyScalar(d)))}else a.object.material.mirror||a.object.material.metalness==1?(t.ray.origin.copy(a.point),t.ray.direction.reflect(l),c.add(f([e[0],a,e[2],e[3],e[4]],o+1))):a.object.material.glass?h==!1?(t.ray.origin.copy(a.point.addScaledVector(l,-M)),t.ray.direction.lerp(l.clone().negate(),a.object.material.refractionRatio),h=!0,c.add(f([e[0],a,e[2],e[3],e[4]],o+1))):(t.ray.origin.copy(a.point.addScaledVector(l,M)),t.ray.direction.lerp(l,a.object.material.refractionRatio),h=!1,c.add(f([e[0],a,e[2],e[3],e[4]],o))):c.add(n.background);c.multiply(r.object.material.color).multiplyScalar(l.dot(t.ray.direction))}else if(a!=null){var b=l.dot(t.ray.direction),d=1;a.object.material.emissiveIntensity&&(d=a.object.material.emissiveIntensity),c.add(r.object.material.color.clone().multiply(a.object.material.color.clone().multiply(a.object.material.emissive.clone().multiplyScalar(b).multiplyScalar(P).multiplyScalar(d))))}}A++}i.lightSamples&&c.multiplyScalar(1/(A+1)),q.lookAt(l);var ae=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()*.5).applyQuaternion(q.quaternion);t.set(r.point,ae);var le=1/(2*Math.PI),b=l.dot(t.ray.direction),ce=1/Math.PI,re=f([e[0],r,e[2],e[3],e[4]],o+1);return c.multiplyScalar(1).add(r.object.material.color.clone().multiply(re).multiplyScalar(b*2))}else{var d=1;return r.object.material.emissiveIntensity&&(d=r.object.material.emissiveIntensity),r.object.material.color.clone().multiply(r.object.material.emissive.clone().multiplyScalar(d))}}var q=new THREE.Object3D,R=0;i.fps||(g=S.length,i.pixelBatchSize&&(g=i.pixelBatchSize));var p=0,ee=this;function J(){try{for(var e=0;e<g;e++){var o=S[R],r=S[R][2]-1;if(r<1&&(r=1),t.setFromCamera(new THREE.Vector2(o[0].x+(Math.random()-.5)*G.x,o[0].y+(Math.random()-.5)*G.y),m),o[3].multiplyScalar(r-1),o[3].add(f(o,0)),o[3].multiplyScalar(1/r),S[R][2]++,R++,s[o[4]]=o[3].r*255,s[o[4]+1]=o[3].g*255,s[o[4]+2]=o[3].b*255,s[o[4]+3]=255,R>=S.length){if(R=0,(i.maxSamples||i.downloadInterval)&&(w>=i.maxSamples||w%i.downloadInterval==0)){var l=new ImageData(new Uint8ClampedArray(s),j,E);if(C.putImageData(l,0,0),ee.download(),w>=i.maxSamples){try{document.getElementById("sa").innerHTML="Render Complete"}catch(A){}return}}w++}}var l=new ImageData(new Uint8ClampedArray(s),j,E);if(C.putImageData(l,0,0),i.fps){var c=performance.now();c-p>1e3/i.fps?g-=10:c-p<1e3/i.fps&&(g+=100),g<1&&(g=1);try{document.getElementById("sa").innerHTML=j+"x"+E+"<br />"+w+"spp "+g+"ppf "+Math.round(1/((c-p)/1e3))+"fps"}catch(d){}p=performance.now()}}catch(d){console.log(d)}setTimeout(J,0)}setTimeout(J,0)}};
